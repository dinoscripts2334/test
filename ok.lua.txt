local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

local Gradient = require(ReplicatedStorage.Packages.Gradients)
local Rarities = require(ReplicatedStorage.Datas.Rarities)
local Animals = require(ReplicatedStorage.Datas.Animals)

-- === Y-Offsets & Traits ===
local animalYOffsets = {
    ["Pot Hotspot"] = 0.23,
    ["La Grande Combinasion"] = -1.6,
    ["Garama and Madundung"] = 0.5,
    ["Trenostruzzo Turbo 3000"] = -1.6,
    ["Torrtuginni Dragonfrutini"] = -1.6,
    ["Graipuss Medussi"] = 0.6,
    ["Espresso Signora"] = -1.3,
    ["Matteo"] = -0.85,
    ["Orcalero Orcala"] = -1.6,
    ["Statutino Libertino"] = -1.15,
    ["Nuclearo Dinossauro"] = 2.2,
    ["Bombardiro Crocodilo"] = 2,
    ["Bombombini Gusini"] = 1.4
}

local traitMultipliers = { Galactic = 3, Nyan = 5, Fireworks = 5, Glitched = 4 }
local traitIcons = {
    Galactic = "rbxassetid://99181785766598",
    Nyan = "rbxassetid://104229924295526",
    Fireworks = "rbxassetid://121100427764858",
    Glitched = "rbxassetid://121332433272976"
}

-- WICHTIG: Alle verfügbaren Traits (muss exakt so heißen wie im Spiel!)
local traitList = { "Galactic", "Nyan", "Fireworks", "Glitched" }

-- === Hilfsfunktionen ===
local function formatNumber(num)
    local suffixes = {"", "K", "M", "B", "T", "Q"}
    local tier = 1
    while num >= 1000 and tier < #suffixes do
        num /= 1000
        tier += 1
    end
    return (num % 1 == 0) and ("%d%s"):format(num, suffixes[tier]) or ("%.1f%s"):format(num, suffixes[tier])
end

local function parseCurrency(str)
    str = str:gsub("<[^>]+>", ""):gsub("%$", ""):gsub(",", "")
    local num, suffix = str:match("^(%d*%.?%d+)(%a*)")
    num = tonumber(num) or 0
    local mult = ({K=1e3, M=1e6, B=1e9, T=1e12, Q=1e15})[suffix:upper()] or 1
    return num * mult
end

-- === Cashout Anzeige ===
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local CashoutFrame = PlayerGui:WaitForChild("LeftBottom"):WaitForChild("LeftBottom"):WaitForChild("Cashout")
local cashoutTweenInfo = TweenInfo.new(5, Enum.EasingStyle.Linear)

local function showCashout(text, isGreen, playSound)
    if not CashoutFrame or not CashoutFrame:FindFirstChild("Template") then return end
    local label = CashoutFrame.Template:Clone()
    label.Text = text
    label.TextColor3 = isGreen and Color3.fromRGB(13, 255, 0) or Color3.fromRGB(255, 0, 0)
    label.Visible = true
    label.Parent = CashoutFrame

    TweenService:Create(label, cashoutTweenInfo, {TextTransparency = 1}):Play()
    TweenService:Create(label.UIStroke, cashoutTweenInfo, {Transparency = 1}):Play()

    task.delay(5, function() if label and label.Parent then label:Destroy() end end)

    if playSound and isGreen then
        pcall(function() require(ReplicatedStorage.Controllers.SoundController):PlaySound("Sounds.Sfx.Cashout") end)
    end
end

-- === Haupt-Spawn-Funktion (100% wie Original, aber stabiler) ===
local function spawnAnimal(animalName, selectedTraits)
    selectedTraits = selectedTraits or {}
    local animalData = Animals[animalName]
    if not animalData then return false, "invalid animal" end

    local animalModel = ReplicatedStorage.Models.Animals:FindFirstChild(animalName)
    if not animalModel then return false, "no model" end

    -- Freien Podiumsplatz finden
    local spawnCFrame, spawnAttachment, claimFrame, hitbox
    for _, plot in ipairs(Workspace.Plots:GetChildren()) do
        local sign = plot:FindFirstChild("PlotSign")
        if sign and sign.SurfaceGui and sign.SurfaceGui.Frame and sign.SurfaceGui.Frame.TextLabel then
            if sign.SurfaceGui.Frame.TextLabel.Text:find(LocalPlayer.Name) then
                local podiums = plot:FindFirstChild("AnimalPodiums")
                if podiums then
                    for _, podium in ipairs(podiums:GetChildren()) do
                        if podium:IsA("Model") and not podium:FindFirstChild("Attachment") then
                            local base = podium:FindFirstChild("Base")
                            if base then
                                local spawn = base:FindFirstChild("Spawn")
                                if spawn then
                                    local ySize = animalModel:GetExtentsSize().Y / 2
                                    local yOffset = animalYOffsets[animalName] or 0
                                    spawnCFrame = spawn.WorldCFrame * CFrame.new(0, ySize + yOffset - 1, 0)
                                    spawnAttachment = spawn
                                    claimFrame = podium:FindFirstChild("Claim") and podium.Claim:FindFirstChild("Main") and podium.Claim.Main:FindFirstChild("Collect")
                                    hitbox = podium:FindFirstChild("Claim") and podium.Claim:FindFirstChild("Hitbox")
                                    goto found
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    ::found::
    if not spawnCFrame then return false, "no free podium" end

    -- Tier klonen & platzieren
    local cloned = animalModel:Clone()
    cloned:SetPrimaryPartCFrame(spawnCFrame)
    cloned.Parent = Workspace
    for _, part in ipairs(cloned:GetDescendants()) do
        if part:IsA("BasePart") then part.Anchored = true end
    end

    -- Idle Animation
    local animCtrl = cloned:FindFirstChildOfClass("AnimationController")
    local idleAnim = ReplicatedStorage.Animations.Animals:FindFirstChild(animalName)
    if idleAnim then idleAnim = idleAnim:FindFirstChild("Idle") end
    if animCtrl and idleAnim then
        animCtrl:LoadAnimation(idleAnim):Play()
    end

    -- Attachment für Erkennung
    local marker = Instance.new("Attachment", spawnAttachment)

    -- Generation & Collect
    local totalGen = 0
    local genRate = animalData.Generation or 0
    for _, trait in ipairs(selectedTraits) do
        genRate += (animalData.Generation or 0) * (traitMultipliers[trait] or 0)
    end

    if claimFrame and hitbox then
        claimFrame.Enabled = true
        local collectLabel = claimFrame:FindFirstChild("Collect")
        if collectLabel then collectLabel.Text = "Collect<br/><font color='#73ff00'>$0</font>" end

        hitbox.CanCollide = false
        local lastCollect = 0
        hitbox.Touched:Connect(function(part)
            if Players:GetPlayerFromCharacter(part.Parent) == LocalPlayer and os.time() - lastCollect >= 1 and totalGen > 0 then
                lastCollect = os.time()
                local cash = LocalPlayer.leaderstats and LocalPlayer.leaderstats:FindFirstChild("Cash")
                if cash then cash.Value += totalGen end
                showCashout("+$"..formatNumber(totalGen), true, true)
                totalGen = 0
                if collectLabel then collectLabel.Text = "Collect<br/><font color='#73ff00'>$0</font>" end
            end
        end)

        task.spawn(function()
            while cloned and cloned.Parent and collectLabel do
                task.wait(1)
                totalGen += genRate
                collectLabel.Text = "Collect<br/><font color='#73ff00'>$"..formatNumber(totalGen).."</font>"
            end
        end)
    end

    -- Sell Prompt
    if cloned.PrimaryPart then
        local prompt = Instance.new("ProximityPrompt", cloned.PrimaryPart)
        prompt.ObjectText = animalData.DisplayName
        prompt.ActionText = "Sell: $"..formatNumber(animalData.Price/2)
        prompt.KeyboardKeyCode = Enum.KeyCode.E
        prompt.HoldDuration = 1.5
        prompt.Triggered:Connect(function(plr)
            if plr ~= LocalPlayer then return end
            local cash = LocalPlayer.leaderstats and LocalPlayer.leaderstats.Cash
            if cash then cash.Value += animalData.Price/2 end
            showCashout("+$"..formatNumber(animalData.Price/2), true, true)
            cloned:Destroy()
            if marker and marker.Parent then marker:Destroy() end
        end)
    end

    -- Overhead GUI
    local overhead = ReplicatedStorage.Overheads.AnimalOverhead:Clone()
    overhead.Adornee = cloned:FindFirstChild("Head") or cloned.PrimaryPart
    overhead.Parent = overhead.Adornee
    overhead.DisplayName.Text = animalData.DisplayName
    overhead.Rarity.Text = animalData.Rarity
    overhead.Price.Text = "$"..formatNumber(animalData.Price.Price)
    overhead.Generation.Text = "$"..formatNumber(genRate).."/s"

    -- Rarity Farben & Effekte
    local rarityCfg = Rarities[animalData.Rarity]
    if rarityCfg then
        local rarityLabel = overhead:FindFirstChild("Rarity", true)
        if animalData.Rarity == "Brainrot God" then
            -- Rainbow Gradient wie im Original
            local colors = {Color3.new(0,0,0), Color3.fromRGB(139,0,0), Color3.new(1,0,0), Color3.fromRGB(128,0,128), Color3.new(0,0,1), Color3.new(0,0,0)}
            local keypoints = {}
            for i = 1, #colors do
                table.insert(keypoints, ColorSequenceKeypoint.new((i-1)/(#colors-1), colors[i]))
            end
            local gradient = Gradient.new(rarityLabel, ColorSequence.new(keypoints), NumberSequence.new(0))
            gradient:SetOffsetSpeed(0.5, 0.5)
        elseif rarityCfg.EasyVisualsPresset then
            -- Andere Effekte
            pcall(function() EasyVisuals.new(rarityLabel, rarityCfg.EasyVisualsPresset, nil, nil, true, rarityCfg.Color) end)
        else
            rarityLabel.TextColor3 = rarityCfg.Color or Color3.new(1,1,1)
        end
    end

    -- Traits (Icons + VFX)
    local traitsContainer = overhead:FindFirstChild("Traits")
    if traitsContainer then
        traitsContainer.Visible = true
        local template = traitsContainer:FindFirstChild("Template")
        for _, trait in ipairs(selectedTraits) do
            -- Icon
            if traitIcons[trait] and template then
                local icon = template:Clone()
                icon.Name = trait
                icon.Image = traitIcons[trait]
                icon.Visible = true
                icon.Parent = traitsContainer
            end

            -- VFX
            local vfx = ReplicatedStorage.Vfx.Traits:FindFirstChild(trait)
            if vfx and vfx:FindFirstChild("VfxInstance") and cloned.PrimaryPart then
                local clone = vfx.VfxInstance:Clone()
                clone.Parent = cloned.PrimaryPart
                if clone:IsA("BasePart") then
                    clone.Anchored = false
                    clone.CanCollide = false
                    clone.Transparency = 1
                    local weld = Instance.new("WeldConstraint", clone)
                    weld.Part0 = cloned.PrimaryPart
                    weld.Part1 = clone
                end
                for _, emitter in ipairs(clone:GetDescendants()) do
                    if emitter:IsA("ParticleEmitter") or emitter:IsA("Trail") then
                        emitter.Enabled = true
                    end
                end
            end
        end
    end

    return true, cloned
end

-- === NEUES UI (Tokyo Lib) ===
local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/drillygzzly/Roblox-UI-Libs/main/1%20Tokyo%20Lib%20(FIXED)/Tokyo%20Lib%20Source.lua"))()
library.cheatname = "Trax Spawner"
library.gamename = "Trax"
library:init()

local window = library.NewWindow({title = "Trax Brainrot Spawner", size = UDim2.fromOffset(520, 420)})
local tab = window:AddTab("Main")

-- Tierliste erstellen
local excluded = {["Secret Lucky Block"]=true, ["Chimpanzini Spiderini"]=true, ["Mythic Lucky Block"]=true, ["Brainrot God Lucky Block"]=true}
local animalList = {}
for name, data in pairs(Animals) do
    if not excluded[name] then table.insert(animalList, name) end
end
table.sort(animalList, function(a,b)
    local ra = Animals[a].Rarity or ""
    local rb = Animals[b].Rarity or ""
    local order = {Secret=1, ["Brainrot God"]=2, Mythic=3, Legendary=4, Epic=5, Rare=6, Common=7}
    return (order[ra] or 99) < (order[rb] or 99)
end)

local selectedAnimal = animalList[1]
local selectedTraits = {}

local section = tab:AddSection("Brainrot Spawner")

section:AddList({
    text = "Select Animal",
    values = animalList,
    selected = selectedAnimal,
    multi = false,
    callback = function(val) selectedAnimal = val end
})

section:AddList({
    text = "Select Traits (Hold Ctrl)",
    values = traitList,
    selected = {},
    multi = true,
    callback = function(val) selectedTraits = val end
})

section:AddButton({
    text = "Spawn Brainrot",
    confirm = true,
    callback = function()
        if not selectedAnimal then warn("Kein Tier ausgewählt!") return end
        local success, result = spawnAnimal(selectedAnimal, selectedTraits)
        if success then
            library:SendNotification("Spawned: "..selectedAnimal.." with "..(#selectedTraits > 0 and table.concat(selectedTraits, ", ") or "no traits"), 4)
        else
            library:SendNotification("Spawn failed: "..tostring(result), 5)
        end
    end
})

library:SendNotification("Trax Spawner loaded!", 5)
